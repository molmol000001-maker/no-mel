<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>飲酒管理</title>
    <meta name="theme-color" content="#0f172a" />
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="icon" href="icons/icon-192.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 UMD -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Framer Motion UMD -->
    <script src="https://unpkg.com/framer-motion/dist/framer-motion.umd.js"></script>
    <!-- Babel for JSX (貼り付けだけで動かすために使用) -->
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <style>html,body,#root{height:100%;}</style>
  </head>
  <body class="bg-slate-100">
    <div id="root"></div>

    <script>
      // PWA
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      }
    </script>

    <!-- アプリ本体。そのまま貼り付けで動作します -->
    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect, useMemo } = React;
      const MotionGlobal = window.Motion || window.motion || window['framer-motion'] || {};
      const motion = MotionGlobal.motion || new Proxy({}, {get: () => (props)=>React.createElement('div', props)});
      const AnimatePresence = MotionGlobal.AnimatePresence || (({children})=>React.createElement(React.Fragment,null,children));

      function App(){
        // ---------- helpers ----------
        const gramsOfAlcohol = (abvPct, ml) => ml * (abvPct / 100) * 0.8; // 0.8g/ml
        const fmtTime = (ts) => {
          const d = new Date(ts);
          const hh = String(d.getHours()).padStart(2, "0");
          const mm = String(d.getMinutes()).padStart(2, "0");
          return `${hh}:${mm}`;
        };
        const fmtMMSS = (s) => {
          const m = Math.floor(s / 60);
          const ss = String(Math.floor(s % 60)).padStart(2, "0");
          return `${m}:${ss}`;
        };

        // 100段階スコア調整
        const C_AT_100 = 0.745;
        const COCKTAIL_DEFAULT_ML = 150;

        // ---------- drink config ----------
        const DRINKS = {
          beer: { name: "ビール", avgAbv: 5, options: [{ label: "350ml", ml: 350 }, { label: "500ml", ml: 500 }] },
          wine: { name: "ワイン", avgAbv: 12, options: [{ label: "グラス(120ml)", ml: 120 }] },
          champagne: { name: "シャンパン", avgAbv: 12, options: [{ label: "フルート(120ml)", ml: 120 }] },
          umeshu: { name: "梅酒", avgAbv: 12, options: [{ label: "グラス(90ml)", ml: 90 }] },
          gin: { name: "ジン", avgAbv: 40, simpleAdd: true, options: [{ label: "", ml: 30 }] },
          vodka: { name: "ウォッカ", avgAbv: 40, simpleAdd: true, options: [{ label: "", ml: 30 }] },
          tequila: { name: "テキーラ", avgAbv: 40, simpleAdd: true, options: [{ label: "", ml: 30 }] },
          rum: { name: "ラム", avgAbv: 40, simpleAdd: true, options: [{ label: "", ml: 30 }] },
          sake: { name: "日本酒", avgAbv: 15, options: [{ label: "お猪口(60ml)", ml: 60 }, { label: "一合(180ml)", ml: 180 }] },
          shochu: { name: "焼酎", avgAbv: 25, simpleAdd: true, options: [{ label: "", ml: 90 }] },
          whisky: { name: "ウイスキー", avgAbv: 40, simpleAdd: true, options: [{ label: "", ml: 30 }] },
          chuhi: { name: "酎ハイ", avgAbv: 7, options: [{ label: "350ml", ml: 350 }, { label: "500ml", ml: 500 }], allowPercent: true, percentRange: { min: 3, max: 12, step: 0.5 } },
          cocktail: { name: "カクテル", avgAbv: 20, options: [{ label: "弱め（10度前後）", abv: 10 }, { label: "レギュラー（20度前後）", abv: 20 }, { label: "強め（30度前後以上）", abv: 30 }] },
          other: { name: "その他", avgAbv: 5, options: [{ label: "100ml", ml: 100 }, { label: "350ml", ml: 350 }, { label: "500ml", ml: 500 }], allowPercent: true, percentRange: { min: 0, max: 96, step: 0.5 }, showMlAlways: true },
        };
        const ORDER = ["beer","wine","champagne","umeshu","gin","vodka","tequila","rum","sake","shochu","whisky","chuhi","cocktail","other"];

        // ---------- settings ----------
        const [weightKg, setWeightKg] = useState(Number(localStorage.getItem("alc_weightKg") || 75));
        const [age, setAge] = useState(Number(localStorage.getItem("alc_age") || 35));
        const [sex, setSex] = useState(localStorage.getItem("alc_sex") || "male");
        const r = useMemo(() => (sex === "male" ? 0.68 : sex === "female" ? 0.55 : 0.62), [sex]);
        const burnRate = useMemo(() => {
          let v = sex === "male" ? 7.2 : sex === "female" ? 6.8 : 7.0;
          if (age < 30) v += 0.2; else if (age >= 60) v -= 0.2;
          return Math.max(3, Math.min(12, Number(v.toFixed(1))));
        }, [sex, age]);

        // ---------- core states ----------
        const [A_g, setAg] = useState(Number(localStorage.getItem("alc_Ag") || 0));
        const [lastTs, setLastTs] = useState(Number(localStorage.getItem("alc_lastTs") || Date.now()));
        const [history, setHistory] = useState(() => {
          const v = localStorage.getItem("alc_hist"); return v ? JSON.parse(v) : [];
        });
        const [lastWaterTs, setLastWaterTs] = useState(Number(localStorage.getItem("alc_lastWater") || 0));

        // ---------- UI states ----------
        const [tab, setTab] = useState("main");
        const [cat, setCat] = useState("beer");
        const [optionIdx, setOptionIdx] = useState(0);
        const [percent, setPercent] = useState("");

        // ソフトドリンク効果
        const [waterBonusSec, setWaterBonusSec] = useState(Number(localStorage.getItem("alc_waterBonusSec") || 0));
        const [lastAlcoholTs, setLastAlcoholTs] = useState(Number(localStorage.getItem("alc_lastAlcohol") || 0));
        useEffect(()=>{ try{ localStorage.setItem("alc_waterBonusSec", String(waterBonusSec)); }catch(e){} },[waterBonusSec]);
        useEffect(()=>{ try{ localStorage.setItem("alc_lastAlcohol", String(lastAlcoholTs)); }catch(e){} },[lastAlcoholTs]);

        const [lastDrinkGrams, setLastDrinkGrams] = useState(Number(localStorage.getItem("alc_lastDrinkGrams") || 0));
        useEffect(()=>{ try{ localStorage.setItem("alc_lastDrinkGrams", String(lastDrinkGrams)); }catch(e){} },[lastDrinkGrams]);

        const [appKey, setAppKey] = useState(0);
        const [toast, setToast] = useState("");
        const showToast = (m)=>{ setToast(m); setTimeout(()=>setToast(""),1500); };

        const [ripple, setRipple] = useState(false);
        const [spin, setSpin] = useState(false);
        const [burstKey, setBurstKey] = useState(0);
        const [showSparks, setShowSparks] = useState(false);
        const [showSparks2, setShowSparks2] = useState(false);
        const [pulseKey, setPulseKey] = useState(0);
        const COLORS = ['#60a5fa','#34d399','#fbbf24','#f472b6','#f87171'];
        const SPARKS1 = [{x:0,y:-60,size:18},{x:40,y:-45,size:14},{x:60,y:-5,size:16},{x:55,y:35,size:14},{x:15,y:60,size:16},{x:-20,y:60,size:14},{x:-55,y:30,size:16},{x:-60,y:-5,size:14},{x:-35,y:-45,size:16},{x:20,y:-60,size:14}];
        const SPARKS2 = [{x:0,y:-85,size:18},{x:70,y:-50,size:16},{x:90,y:0,size:18},{x:65,y:55,size:16},{x:0,y:85,size:18},{x:-70,y:50,size:16},{x:-90,y:0,size:18},{x:-65,y:-55,size:16}];

        // persist
        useEffect(()=>{ try{ localStorage.setItem("alc_weightKg", String(weightKg)); }catch(e){} },[weightKg]);
        useEffect(()=>{ try{ localStorage.setItem("alc_age", String(age)); }catch(e){} },[age]);
        useEffect(()=>{ try{ localStorage.setItem("alc_sex", String(sex)); }catch(e){} },[sex]);
        useEffect(()=>{ try{ localStorage.setItem("alc_Ag", String(A_g)); }catch(e){} },[A_g]);
        useEffect(()=>{ try{ localStorage.setItem("alc_lastTs", String(lastTs)); }catch(e){} },[lastTs]);
        useEffect(()=>{ try{ localStorage.setItem("alc_hist", JSON.stringify(history)); }catch(e){} },[history]);
        useEffect(()=>{ try{ localStorage.setItem("alc_lastWater", String(lastWaterTs)); }catch(e){} },[lastWaterTs]);

        // decay timer (1min)
        useEffect(()=>{
          const id = setInterval(()=>{
            const now = Date.now();
            const dt_h = Math.max(0, (now - lastTs) / 3600000);
            const newA = Math.max(0, A_g - burnRate * dt_h);
            setAg(newA); setLastTs(now);
          }, 60000);
          return ()=>clearInterval(id);
        }, [A_g, lastTs, burnRate]);

        const [secTick, setSecTick] = useState(0);
        useEffect(()=>{
          const id = setInterval(()=>setSecTick(t=>t+1), 1000);
          return ()=>clearInterval(id);
        }, []);

        const cfg = DRINKS[cat];
        const curOption = cfg.options[Math.max(0, Math.min(optionIdx, (cfg.options?.length || 1) - 1))] || { label: "", ml: 0 };
        const baseAbv = curOption && curOption.abv != null ? curOption.abv : cfg.allowPercent ? Number(percent || cfg.avgAbv) : cfg.avgAbv;
        const ml = cat === "cocktail" ? COCKTAIL_DEFAULT_ML : curOption.ml;

        const decayedA = (at) => {
          const dt_h = Math.max(0, (at - lastTs) / 3600000);
          return Math.max(0, A_g - burnRate * dt_h);
        };
        const A_now = React.useMemo(()=>decayedA(Date.now()), [A_g, lastTs, burnRate, secTick]);
        const C = React.useMemo(()=> (r>0 && weightKg>0 ? A_now/(r*weightKg) : 0), [A_now, r, weightKg]);
        const scoreExact = React.useMemo(()=> Math.max(0, Math.min(100, (C/ C_AT_100) * 100)), [C]);
        const score100 = Math.round(scoreExact);

        const stageInfo = (s) => {
          if (s < 15) return { idx: 1, label: 'しらふ', chip: 'bg-gray-200 text-gray-800', bar: 'bg-gray-400' };
          if (s < 45) return { idx: 2, label: 'ほろ酔い', chip: 'bg-green-100 text-green-800', bar: 'bg-green-500' };
          if (s < 75) return { idx: 3, label: 'パーティ', chip: 'bg-sky-100 text-sky-800', bar: 'bg-sky-500' };
          if (s < 90) return { idx: 4, label: '酩酊', chip: 'bg-amber-100 text-amber-900', bar: 'bg-amber-500' };
          return { idx: 5, label: '危険', chip: 'bg-red-100 text-red-700', bar: 'bg-red-600' };
        };
        const stage = React.useMemo(()=> stageInfo(score100), [score100]);

        const secondsToTarget = (Acur, Atarget, rate) => {
          if (Acur <= Atarget) return 0;
          const over = Acur - Atarget;
          const hours = over / Math.max(0.0001, rate);
          return Math.max(0, Math.ceil(hours * 3600));
        };

        const targetScore = 43;
        const C_target = C_AT_100 * (targetScore / 100);
        const A_target = C_target * r * weightKg;
        const targetBaseSec = secondsToTarget(A_now, A_target, burnRate);
        const minCooldownSec = lastAlcoholTs ? Math.max(0, Math.round((lastDrinkGrams / 20) * 1800) - Math.floor((Date.now() - lastAlcoholTs) / 1000)) : 0;
        const gramsRecent60 = (()=>{
          const cutoff = Date.now() - 60*60*1000;
          let sum = 0;
          for (const h of history) {
            if (h.type==='alcohol' && h.ts>=cutoff) {
              const abv = Number(h.abv||0);
              const vol = Number(h.ml||0);
              sum += gramsOfAlcohol(abv, vol);
            }
          }
          return sum;
        })();
        const friendlyCapSec = Math.max(0, Math.round((gramsRecent60 / 20) * 1800));
        const policyBaseSec = Math.max(minCooldownSec, Math.min(targetBaseSec, friendlyCapSec));
        const effectiveBonusSec = Math.min(waterBonusSec, policyBaseSec);
        const nextOkSec = Math.max(0, policyBaseSec - effectiveBonusSec);

        const hasAnyAlcohol = React.useMemo(()=> history.some(h=>h.type==='alcohol'), [history]);
        const displaySec = hasAnyAlcohol ? nextOkSec : 0;

        const computeHeaderScoreExact = (se, has, sec, tgt)=> (has && sec===0) ? Math.min(se, tgt) : se;
        const headerScoreExact = React.useMemo(()=> computeHeaderScoreExact(scoreExact, hasAnyAlcohol, displaySec, targetScore), [scoreExact, hasAnyAlcohol, displaySec, targetScore]);
        const headerStage = React.useMemo(()=> stageInfo(Math.round(headerScoreExact)), [headerScoreExact]);

        const needsWaterAfter = (hist)=> hist.length>0 && hist[0].type === 'alcohol';
        const needsWater = needsWaterAfter(history);

        const addDrink = () => {
          if (needsWater) { alert("次の一杯の前にソフトドリンクを挟んでください"); return; }
          try{ if (navigator.vibrate) navigator.vibrate(10); }catch(e){}
          const g = gramsOfAlcohol(baseAbv, ml);
          const now = Date.now();
          const aNow = decayedA(now);
          setAg(aNow + g); setLastTs(now);
          setLastAlcoholTs(now); setLastDrinkGrams(g); setWaterBonusSec(0);
          const labelParts = [
            DRINKS[cat].name,
            cat==="cocktail" ? (curOption.label||"") : (!DRINKS[cat].simpleAdd && (((DRINKS[cat].options?.length||0)>1) || DRINKS[cat].showMlAlways) ? (curOption.label||"") : ""),
            (curOption && curOption.abv!=null) ? `${curOption.abv}%` : (DRINKS[cat].allowPercent ? `${baseAbv}%` : `平均${DRINKS[cat].avgAbv}%`),
          ];
          setHistory((h)=> [{ id: Math.random().toString(36).slice(2), ts: now, type: "alcohol", label: labelParts.filter(Boolean).join(" · "), abv: baseAbv, ml }, ...h]);
          setTab("main");
        };

        const addWater = () => {
          try{ if (navigator.vibrate) navigator.vibrate(10); }catch(e){}
          const now = Date.now();
          const mandatory = history.length>0 && history[0].type==='alcohol';
          setHistory((h)=> [{ id: Math.random().toString(36).slice(2), ts: now, type: "water", label: "ソフトドリンク/水" }, ...h]);
          setLastWaterTs(now);
          if (!mandatory) setWaterBonusSec(s=> s + 600); // 10分短縮
        };

        const handleWaterClick = () => {
          try{ if (navigator.vibrate) navigator.vibrate([10,30,10]); }catch(e){}
          setRipple(true); setPulseKey(k=>k+1); setSpin(true);
          setShowSparks(true); setShowSparks2(true); setBurstKey(k=>k+1);
          setTimeout(()=>setRipple(false),1100);
          setTimeout(()=>setShowSparks(false),800);
          setTimeout(()=>setShowSparks2(false),1000);
          setTimeout(()=>{ addWater(); setSpin(false); }, 700);
        };

        const endSession = () => {
          try{ if (navigator.vibrate) navigator.vibrate(20); }catch(e){}
          const now = Date.now();
          try{
            localStorage.setItem("alc_Ag","0");
            localStorage.setItem("alc_lastTs", String(now));
            localStorage.setItem("alc_lastWater","0");
            localStorage.setItem("alc_hist", JSON.stringify([]));
            localStorage.setItem("alc_lastAlcohol","0");
            localStorage.setItem("alc_waterBonusSec","0");
            localStorage.setItem("alc_lastDrinkGrams","0");
          }catch(e){}
          setAg(0); setLastTs(now); setLastWaterTs(0); setHistory([]);
          setCat("beer"); setOptionIdx(0); setPercent("");
          setLastAlcoholTs(0); setLastDrinkGrams(0); setWaterBonusSec(0);
          setTab("main"); setSecTick(t=>t+1); setAppKey(k=>k+1);
        };

        return (
          <div className="min-h-[100dvh] w-full text-slate-900 bg-gradient-to-b from-slate-50 to-slate-100">
            <div key={appKey} className="max-w-md mx-auto relative flex flex-col min-h-[100dvh]">
              {/* header */}
              <header className="sticky top-0 z-20 backdrop-blur bg-white/70 border-b border-slate-200" style={{ paddingTop: "env(safe-area-inset-top)" }}>
                <div className="px-4 py-3">
                  <div className="flex items-center justify-between">
                    <div className="font-semibold">飲酒管理</div>
                    <div className="text-right leading-tight w-40">
                      <div className="text-[10px] text-slate-500 flex items-center justify-between gap-1">
                        <span>酔い度ゲージ</span>
                        <span className={`shrink-0 px-1.5 py-0.5 rounded ${headerStage.chip}`}>{headerStage.label}</span>
                      </div>
                      <div className="w-full h-1.5 bg-slate-200 rounded-full overflow-hidden mt-1">
                        <div className={`h-full ${headerStage.bar} transition-[width] duration-700`} style={{ width: `${Math.max(0, Math.min(100, headerScoreExact))}%` }} />
                      </div>
                    </div>
                  </div>
                </div>
              </header>

              {/* main */}
              <main className="flex-1 px-4 pb-32 pt-3">
                {/* タイマー＆選択 */}
                <section className="bg-white rounded-2xl p-4 shadow-sm grid gap-4" style={{ display: tab === "main" ? "grid" : "none" }}>
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="text-2xl font-bold tracking-tight">{fmtMMSS(hasAnyAlcohol ? nextOkSec : 0)}</div>
                      {hasAnyAlcohol && nextOkSec > 0 && (
                        <div className="text-[11px] text-slate-500">（{fmtTime(Date.now() + nextOkSec * 1000)} 目安）</div>
                      )}
                      {effectiveBonusSec > 0 && (
                        <div className="text-[11px] text-slate-500">ソフトドリンク効果: -{Math.floor(effectiveBonusSec / 60)}分</div>
                      )}
                    </div>
                    <button onClick={addWater} className="h-11 px-4 rounded-xl bg-slate-100 font-semibold active:scale-[.98]">ソフトドリンク</button>
                  </div>

                  <div className="grid grid-cols-3 gap-2">
                    {ORDER.map((id) => (
                      <button key={id}
                        className={`h-11 px-3 rounded-xl text-sm font-semibold border active:scale-[.98] ${cat === id ? 'bg-slate-900 text-white' : 'bg-white'}`}
                        onClick={()=>{ setCat(id); setOptionIdx(0); setPercent(""); }}>
                        {DRINKS[id].name}
                      </button>
                    ))}
                  </div>

                  {cat === 'cocktail' ? (
                    <>
                      <div>
                        <div className="text-xs text-slate-500">強さ</div>
                        <div className="flex flex-wrap gap-2 mt-2">
                          {DRINKS.cocktail.options.map((op, idx) => (
                            <button key={op.label}
                              className={`h-11 px-3 rounded-xl text-sm font-semibold border active:scale-[.98] ${optionIdx === idx ? 'bg-slate-900 text-white' : 'bg-white'}`}
                              onClick={()=>setOptionIdx(idx)}>
                              {op.label}
                            </button>
                          ))}
                        </div>
                      </div>

                      <div className="bg-slate-50 border rounded-xl p-3 text-xs text-slate-600">
                        {optionIdx === 0 && (<p>弱め（10度前後）：カシスオレンジやファジーネーブルなど、ジュースベースの飲みやすいカクテル。</p>)}
                        {optionIdx === 1 && (<p>レギュラー（20度前後）：ウォッカ、ジン、テキーラ、ラムなどのスピリッツをベースに他の材料を加えて作られます。</p>)}
                        {optionIdx === 2 && (<p>強め（30度前後以上）：マティーニ、マンハッタン、モヒートなど、スピリッツ比率が高め。</p>)}
                      </div>

                      <div className="mt-2">
                        <button disabled={needsWater} aria-disabled={needsWater}
                          className={`w-full h-12 px-4 rounded-xl font-semibold active:scale-[.98] ${needsWater ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-slate-900 text-white'}`}
                          onClick={addDrink}>この内容で追加</button>
                      </div>
                      {needsWater && (<div className="text-[11px] text-rose-600">一杯お酒を飲んだら、一杯ソフトドリンクを挟んでください。</div>)}
                    </>
                  ) : (
                    <>
                      {(!DRINKS[cat].simpleAdd && ((DRINKS[cat].options?.length || 0) > 1)) && (
                        <div className="grid grid-cols-2 gap-3">
                          <div>
                            <div className="text-xs text-slate-500">量</div>
                            <div className="flex flex-wrap gap-2 mt-2">
                              {DRINKS[cat].options.map((op, idx) => (
                                <button key={op.label}
                                  className={`h-11 px-3 rounded-xl text-sm font-semibold border active:scale-[.98] ${optionIdx === idx ? 'bg-slate-900 text-white' : 'bg-white'}`}
                                  onClick={()=>setOptionIdx(idx)}>
                                  {op.label || '既定量'}
                                </button>
                              ))}
                            </div>
                          </div>
                          {DRINKS[cat].allowPercent && (
                            <div>
                              <div className="text-xs text-slate-500">度数（%）</div>
                              <input className="w-full mt-1 border rounded-xl px-3 h-11" type="number"
                                min={DRINKS[cat].percentRange.min} max={DRINKS[cat].percentRange.max} step={DRINKS[cat].percentRange.step}
                                value={percent === '' ? DRINKS[cat].avgAbv : percent}
                                onChange={(e)=> setPercent(e.target.value === '' ? '' : Number(e.target.value))} />
                              <div className="text-[11px] text-slate-500 mt-1">未入力時は平均{DRINKS[cat].avgAbv}%で推定</div>
                            </div>
                          )}
                        </div>
                      )}

                      {(!DRINKS[cat].simpleAdd && ((DRINKS[cat].options?.length || 0) <= 1) && DRINKS[cat].allowPercent) && (
                        <div>
                          <div className="text-xs text-slate-500">度数（%）</div>
                          <input className="w-full mt-1 border rounded-xl px-3 h-11" type="number"
                            min={DRINKS[cat].percentRange.min} max={DRINKS[cat].percentRange.max} step={DRINKS[cat].percentRange.step}
                            value={percent === '' ? DRINKS[cat].avgAbv : percent}
                            onChange={(e)=> setPercent(e.target.value === '' ? '' : Number(e.target.value))} />
                          <div className="text-[11px] text-slate-500 mt-1">未入力時は平均{DRINKS[cat].avgAbv}%で推定</div>
                        </div>
                      )}

                      <div className="mt-2">
                        <button disabled={needsWater} aria-disabled={needsWater}
                          className={`w-full h-12 px-4 rounded-xl font-semibold active:scale-[.98] ${needsWater ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-slate-900 text-white'}`}
                          onClick={addDrink}>この内容で追加</button>
                      </div>
                      {needsWater && (<div className="text-[11px] text-rose-600">一杯お酒を飲んだら、一杯ソフトドリンクを挟んでください。</div>)}
                    </>
                  )}
                </section>

                {/* 履歴 */}
                <section className="bg-white rounded-2xl p-4 shadow-sm" style={{ display: tab === "history" ? "block" : "none" }}>
                  {history.length === 0 ? (
                    <div className="text-slate-500">まだ履歴はありません。</div>
                  ) : (
                    <div className="grid gap-3">
                      {history.map((h)=>(
                        <div key={h.id} className="border rounded-xl p-3">
                          <div className="text-[11px] text-slate-500">{fmtTime(h.ts)}</div>
                          <div className="font-medium text-sm">{h.label}</div>
                        </div>
                      ))}
                    </div>
                  )}
                </section>

                {/* 設定 */}
                <section className="bg-white rounded-2xl p-4 shadow-sm grid gap-4" style={{ display: tab === "settings" ? "grid" : "none" }}>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <div className="text-xs text-slate-500">体重 (kg)</div>
                      <input className="w-full mt-1 border rounded-xl px-3 h-11" type="number" min="30" max="200"
                        value={weightKg} onChange={(e)=> setWeightKg(Number(e.target.value))} />
                    </div>
                    <div>
                      <div className="text-xs text-slate-500">年齢</div>
                      <input className="w-full mt-1 border rounded-xl px-3 h-11" type="number" min="16" max="99"
                        value={age} onChange={(e)=> setAge(Number(e.target.value))} />
                    </div>
                    <div className="col-span-2">
                      <div className="text-xs text-slate-500 mb-1">性別</div>
                      <div className="flex gap-2">
                        {[{id:'male',label:'男性'},{id:'female',label:'女性'},{id:'other',label:'その他'}].map(opt=>(
                          <button key={opt.id} onClick={()=>setSex(opt.id)}
                            className={`h-11 px-3 rounded-xl text-sm font-semibold border active:scale-[.98] ${sex===opt.id ? 'bg-slate-900 text-white' : 'bg-white'}`}>
                            {opt.label}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>

                  <div className="grid gap-2">
                    <button type="button" onClick={endSession} className="w-full h-12 px-4 rounded-xl border font-semibold active:scale-[.98]">飲み会終了</button>
                  </div>
                  <div className="text-[10px] text-slate-500">PWAプレビュー · データはこの端末に保存（localStorage）</div>
                </section>
              </main>

              {/* ソフトドリンク オーバーレイ */}
              <AnimatePresence>
                {needsWater && (
                  <motion.div key="gate"
                    className="fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-center justify-center p-6"
                    initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} transition={{ duration: 0.25 }}>
                    <motion.div className="bg-white rounded-2xl w-full max-w-xs p-6 text-center shadow-xl"
                      initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.95 }} transition={{ duration: 0.25 }}>
                      <div className="text-sm text-slate-600 mb-4">一杯お酒を飲んだので、次の前にソフトドリンクを挟みましょう。</div>
                      <div className="flex flex-col items-center relative">
                        <AnimatePresence>
                          {ripple && (
                            <motion.span key={`pulse-${pulseKey}`} className="absolute h-28 w-28 rounded-full ring-2 ring-sky-400/60"
                              initial={{ scale: 0.9, opacity: 0.6 }} animate={{ scale: 1.25, opacity: 0 }} exit={{ opacity: 0 }} transition={{ duration: 0.9, ease: 'easeOut' }} />
                          )}
                        </AnimatePresence>
                        {ripple && (
                          <motion.span key="ripple1" className="absolute h-24 w-24 rounded-full" style={{ background: 'rgba(59,130,246,0.20)' }}
                            initial={{ scale: 1, opacity: 0.6 }} animate={{ scale: 1.9, opacity: 0 }} transition={{ duration: 0.9 }} />
                        )}
                        {ripple && (
                          <motion.span key="ripple2" className="absolute h-24 w-24 rounded-full" style={{ background: 'rgba(59,130,246,0.15)' }}
                            initial={{ scale: 0.9, opacity: 0.5 }} animate={{ scale: 2.2, opacity: 0 }} transition={{ duration: 1.1, delay: 0.15 }} />
                        )}
                        <AnimatePresence>
                          <motion.span key={`sheen-${burstKey}`} className="pointer-events-none absolute h-24 w-24 rounded-full overflow-hidden"
                            initial={{ opacity: 0.9 }} animate={{ opacity: 0.0 }} exit={{ opacity: 0 }} transition={{ duration: 0.9 }}>
                            <motion.span className="absolute -left-24 top-0 h-24 w-14 rotate-45"
                              style={{background:'linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,0.85), rgba(255,255,255,0))'}}
                              initial={{ x: -100 }} animate={{ x: 100 }} exit={{ opacity: 0 }} transition={{ duration: 0.9, ease: 'easeOut' }} />
                          </motion.span>
                        </AnimatePresence>
                        <AnimatePresence>
                          {showSparks && SPARKS1.map((s,i)=>(
                            <motion.span key={`sp1-${burstKey}-${i}`} className="absolute select-none"
                              style={{left:'50%',top:'50%',marginLeft:-8,marginTop:-8,fontSize:s.size,color:COLORS[i%COLORS.length]}}
                              initial={{ x:0,y:0,rotate:0,opacity:0 }} animate={{ x:s.x,y:s.y,rotate:25,opacity:1 }} exit={{ opacity:0 }} transition={{ duration:0.6, ease:'easeOut' }}>
                              ✨
                            </motion.span>
                          ))}
                        </AnimatePresence>
                        <AnimatePresence>
                          {showSparks2 && SPARKS2.map((s,i)=>(
                            <motion.span key={`sp2-${burstKey}-${i}`} className="absolute select-none"
                              style={{left:'50%',top:'50%',marginLeft:-8,marginTop:-8,fontSize:s.size,color:COLORS[(i+2)%COLORS.length]}}
                              initial={{ x:0,y:0,rotate:0,opacity:0 }} animate={{ x:s.x,y:s.y,rotate:-15,opacity:1 }} exit={{ opacity:0 }} transition={{ duration:0.8, ease:'easeOut' }}>
                              ✨
                            </motion.span>
                          ))}
                        </AnimatePresence>

                        <motion.button aria-label="ソフトドリンクを記録" whileTap={{ scale: 0.88 }} animate={{ rotate: spin ? 720 : 0 }} transition={{ duration: 0.8, ease: 'easeOut' }}
                          onClick={handleWaterClick} className="h-24 w-24 rounded-full bg-slate-900 text-white font-bold shadow-lg transition grid place-items-center">
                          <span className="text-2xl">💧</span>
                        </motion.button>
                        <div className="mt-3 text-xs text-slate-500">ソフトドリンク</div>
                      </div>
                    </motion.div>
                  </motion.div>
                )}
              </AnimatePresence>

              {/* トースト */}
              <AnimatePresence>
                {toast && (
                  <motion.div key="toast"
                    className="fixed left-1/2 -translate-x-1/2 bottom-24 z-40 px-3 py-2 rounded-lg bg-slate-900 text-white text-xs shadow"
                    initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 10 }} transition={{ duration: 0.2 }}>
                    {toast}
                  </motion.div>
                )}
              </AnimatePresence>

              {/* フッタータブ */}
              <nav className="fixed inset-x-0 bottom-0 z-20 border-t border-slate-200 bg-white/95 backdrop-blur" style={{ paddingBottom: "env(safe-area-inset-bottom)" }}>
                <div className="max-w-md mx-auto grid grid-cols-3">
                  {["main","history","settings"].map((t)=>(
                    <button key={t} onClick={()=>setTab(t)}
                      className={`flex flex-col items-center justify-center h-14 gap-0.5 ${tab===t ? 'text-slate-900' : 'text-slate-400'}`} style={{minHeight:56}}>
                      <span className="text-[11px] font-medium">{t==='main'?'メイン':t==='history'?'履歴':'設定'}</span>
                    </button>
                  ))}
                </div>
              </nav>

            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
