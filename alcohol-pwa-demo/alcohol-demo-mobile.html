<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>飲酒管理（PWAデモ）</title>
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="apple-touch-icon" href="./icons/icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    body { background: linear-gradient(to bottom, #f8fafc, #eef2f7); }
  </style>
</head>
<body class="text-slate-900">
  <div id="root"></div>

  <!-- React (prod UMD) & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ---------- Helpers ----------
    const gramsOfAlcohol = (abvPct, ml) => ml * (abvPct/100) * 0.8;
    const fmtTime = (ts) => {
      const d = new Date(ts);
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${hh}:${mm}`;
    };
    const levelFromC = (C) => {
      const thresholds = [
        { level: 0, maxC: 0.1 },
        { level: 1, maxC: 0.2 },
        { level: 2, maxC: 0.3 },
        { level: 3, maxC: 0.4 },
        { level: 4, maxC: 0.5 },
        { level: 5, maxC: Infinity },
      ];
      for (const t of thresholds) if (C <= t.maxC) return t.level;
      return 5;
    };
    const HYDRATION_INTERVAL_MIN = 60;
    const C_FOR_LEVEL = {0:0.1,1:0.2,2:0.3,3:0.4,4:0.5,5:0.6};
    const COCKTAIL_DEFAULT_ML = 150;

    // ---------- Drink Config ----------
    const DRINKS = {
      beer:   { name:"ビール", avgAbv:5,  options:[{label:"350ml", ml:350},{label:"500ml", ml:500}] },
      wine:   { name:"ワイン", avgAbv:12, options:[{label:"グラス(120ml)", ml:120}] },
      gin:    { name:"ジン",   avgAbv:40, options:[{label:"", ml:30}], simpleAdd:true },
      vodka:  { name:"ウォッカ",avgAbv:40, options:[{label:"", ml:30}], simpleAdd:true },
      sake:   { name:"日本酒", avgAbv:15, options:[{label:"お猪口(60ml)", ml:60},{label:"一合(180ml)", ml:180}] },
      shochu: { name:"焼酎",   avgAbv:25, options:[{label:"", ml:90}],  simpleAdd:true },
      whisky: { name:"ウイスキー",avgAbv:40, options:[{label:"", ml:30}], simpleAdd:true },
      chuhi:  { name:"酎ハイ", avgAbv:7,  options:[{label:"350ml", ml:350},{label:"500ml", ml:500}], allowPercent:true, percentRange:{min:3,max:12,step:0.5} },
      cocktail:{name:"カクテル",avgAbv:20, options:[{label:"弱め（10度前後）", abv:10},{label:"レギュラー（20度前後）", abv:20},{label:"強め（30度前後以上）", abv:30}] },
      other:  { name:"その他", avgAbv:5,  options:[{label:"100ml", ml:100}], allowPercent:true, percentRange:{min:0,max:96,step:0.5} },
    };
    const ORDER = ["beer","wine","gin","vodka","sake","shochu","whisky","chuhi","cocktail","other"];

    function Badge({ level }){
      const labels = ["0 素面","1 ほろ","2 良い感じ","3 注意","4 強い酔い","5 危険域"];
      const cls = ["bg-gray-200 text-gray-800","bg-green-200 text-green-800","bg-emerald-200 text-emerald-800","bg-amber-200 text-amber-900","bg-orange-300 text-orange-900","bg-red-500 text-white"];
      return <span className={`px-2.5 py-1 rounded-2xl text-xs font-semibold ${cls[level]}`}>{labels[level]}</span>;
    }

    function App(){
      // Settings
      const [weightKg, setWeightKg] = useState(Number(localStorage.getItem("alc_weightKg") || 75));
      const [age, setAge] = useState(Number(localStorage.getItem("alc_age") || 35));
      const [sex, setSex] = useState(localStorage.getItem("alc_sex") || "male");
      const r = useMemo(()=> sex==="male"?0.68:sex==="female"?0.55:0.62, [sex]);
      const burnRate = useMemo(()=> {
        let v = sex==="male"?7.2:sex==="female"?6.8:7.0;
        if(age<30) v+=0.2; else if(age>=60) v-=0.2;
        return Math.max(3, Math.min(12, Number(v.toFixed(1))));
      }, [sex,age]);
      const limitLevel = 3;

      // Core
      const [A_g, setAg] = useState(Number(localStorage.getItem("alc_Ag") || 0));
      const [lastTs, setLastTs] = useState(Number(localStorage.getItem("alc_lastTs") || Date.now()));
      const [history, setHistory] = useState(()=> { const v = localStorage.getItem("alc_hist"); return v? JSON.parse(v):[]; });
      const [lastWaterTs, setLastWaterTs] = useState(Number(localStorage.getItem("alc_lastWater") || 0));

      // UI
      const [tab, setTab] = useState("home");
      const [cat, setCat] = useState("beer");
      const [optionIdx, setOptionIdx] = useState(0);
      const [percent, setPercent] = useState("");

      // Persist
      useEffect(()=>localStorage.setItem("alc_weightKg", String(weightKg)),[weightKg]);
      useEffect(()=>localStorage.setItem("alc_age", String(age)),[age]);
      useEffect(()=>localStorage.setItem("alc_sex", String(sex)),[sex]);
      useEffect(()=>localStorage.setItem("alc_Ag", String(A_g)),[A_g]);
      useEffect(()=>localStorage.setItem("alc_lastTs", String(lastTs)),[lastTs]);
      useEffect(()=>localStorage.setItem("alc_hist", JSON.stringify(history)),[history]);
      useEffect(()=>localStorage.setItem("alc_lastWater", String(lastWaterTs)),[lastWaterTs]);

      // Decay
      useEffect(()=>{
        const id = setInterval(()=>{
          const now = Date.now();
          const dt_h = Math.max(0, (now - lastTs)/3600000);
          const newA = Math.max(0, A_g - burnRate*dt_h);
          setAg(newA);
          setLastTs(now);
        }, 60000);
        return ()=>clearInterval(id);
      }, [A_g,lastTs,burnRate]);

      const cfg = DRINKS[cat];
      const curOption = cfg.options[Math.max(0, Math.min(optionIdx, cfg.options.length-1))];
      const baseAbv = (curOption && curOption.abv!=null) ? curOption.abv : (cfg.allowPercent ? Number(percent || cfg.avgAbv) : cfg.avgAbv);
      const ml = (cat==="cocktail") ? COCKTAIL_DEFAULT_ML : curOption.ml;
      const displayG = gramsOfAlcohol(baseAbv, ml);

      const decayedA = (at) => {
        const dt_h = Math.max(0, (at - lastTs)/3600000);
        return Math.max(0, A_g - burnRate*dt_h);
      };
      const C = useMemo(()=> (r>0 && weightKg>0) ? A_g/(r*weightKg) : 0, [A_g,r,weightKg]);
      const level = useMemo(()=> levelFromC(C), [C]);
      const predictNextOkMinutes = (abv,ml) => {
        const aNow = decayedA(Date.now());
        const gNext = gramsOfAlcohol(abv, ml);
        const A_target = (C_FOR_LEVEL[limitLevel]||0.4) * r * weightKg;
        if(aNow + gNext <= A_target) return 0;
        const over = aNow + gNext - A_target;
        const hours = over / burnRate;
        return Math.max(0, Math.ceil(hours*60));
      };
      const nextOkMin = predictNextOkMinutes(baseAbv, ml);

      const addDrink = () => {
        try { navigator.vibrate && navigator.vibrate(10); } catch {}
        const g = gramsOfAlcohol(baseAbv, ml);
        const now = Date.now();
        const aNow = decayedA(now);
        setAg(aNow + g);
        setLastTs(now);
        const labelParts = [
          cfg.name,
          (cat==="cocktail") ? (curOption.label||"") : (!["gin","vodka","whisky","shochu","cocktail"].includes(cat) ? (curOption.label||"") : ""),
          (curOption && curOption.abv!=null) ? `${curOption.abv}%` : (cfg.allowPercent ? `${baseAbv}%` : `平均${cfg.avgAbv}%`),
        ];
        setHistory(h => [{ id: Math.random().toString(36).slice(2), ts: now, type:"alcohol", label: labelParts.filter(Boolean).join(" · "), g, abv: baseAbv, ml }, ...h]);
        setTab("home");
      };
      const addWater = () => {
        try { navigator.vibrate && navigator.vibrate(10); } catch {}
        const now = Date.now();
        setHistory(h => [{ id: Math.random().toString(36).slice(2), ts: now, type:"water", label:"ソフトドリンク/水" }, ...h ]);
        setLastWaterTs(now);
      };
      const endSession = () => {
        if(!confirm("セッションを終了し、数値をリセットしますか？")) return;
        setAg(0); setLastTs(Date.now()); setLastWaterTs(0);
      };

      const totalG = useMemo(()=> history.filter(x=>x.type==="alcohol").reduce((s,x)=>s+(x.g||0),0), [history]);

      return (
        <div className="min-h-[100dvh] w-full">
          <div className="max-w-md mx-auto relative flex flex-col min-h-[100dvh]">
            <header className="sticky top-0 z-20 backdrop-blur bg-white/70 border-b border-slate-200" style={{paddingTop:"env(safe-area-inset-top)"}}>
              <div className="px-4 py-3 flex items-center justify-between">
                <div className="font-semibold">飲酒管理</div>
                <div className="text-right leading-tight">
                  <div className="text-[10px] text-slate-500">現在の酔い度</div>
                  <div className="flex items-center gap-2">
                    <Badge level={level} />
                    <div className="text-[11px] text-slate-500">C {C.toFixed(3)} g/kg</div>
                  </div>
                </div>
              </div>
            </header>

            <main className="flex-1 px-4 pb-32 pt-3">
              {/* Home */}
              <section className="grid gap-3" style={{display: (tab==="home"?"grid":"none")}}>
                <div className="bg-white rounded-2xl p-4 shadow-sm">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="text-xs text-slate-500">アクティブ純アル</div>
                      <div className="text-2xl font-bold tracking-tight">{A_g.toFixed(1)} g</div>
                    </div>
                    <button onClick={addWater} className="h-11 px-4 rounded-xl bg-slate-100 font-semibold active:scale-[.98]">ソフトドリンク</button>
                  </div>
                </div>

                <div className="bg-white rounded-2xl p-4 shadow-sm grid grid-cols-2 gap-4">
                  <div>
                    <div className="text-xs text-slate-500">総純アル（今夜）</div>
                    <div className="text-lg font-semibold">{totalG.toFixed(1)} g</div>
                  </div>
                  <div>
                    <div className="text-xs text-slate-500">次の一杯の目安</div>
                    {nextOkMin===0 ? (
                      <div className="text-lg font-semibold">今すぐOK</div>
                    ) : (
                      <div>
                        <div className="text-lg font-semibold">{nextOkMin} 分後</div>
                        <div className="text-[11px] text-slate-500">（{fmtTime(Date.now() + nextOkMin*60000)} 目安）</div>
                      </div>
                    )}
                  </div>
                </div>

                <div className="bg-white rounded-2xl p-4 shadow-sm">
                  <div className="text-xs text-slate-500 mb-2">プレビュー中の次の一杯</div>
                  <div className="text-sm">
                    {(()=>{
                      const name = DRINKS[cat].name;
                      const showVol = !["gin","vodka","whisky","shochu","cocktail"].includes(cat);
                      const second = showVol ? (DRINKS[cat].options[optionIdx]?.label) : null;
                      const abvText = (DRINKS[cat].options[optionIdx]?.abv!=null) ? `${DRINKS[cat].options[optionIdx].abv}%` : (DRINKS[cat].allowPercent ? `${(percent===""? DRINKS[cat].avgAbv : percent)}%` : `平均${DRINKS[cat].avgAbv}%`);
                      return [name, second, abvText].filter(Boolean).join(" · ");
                    })()} ≈ <span className="font-semibold">{displayG.toFixed(1)} g</span>
                  </div>
                </div>
              </section>

              {/* Drink */}
              <section className="bg-white rounded-2xl p-4 shadow-sm grid gap-4" style={{display: (tab==="drink"?"grid":"none")}}>
                <div className="grid grid-cols-3 gap-2">
                  {ORDER.map(id => (
                    <button key={id}
                      className={`h-11 px-3 rounded-xl text-sm font-semibold border active:scale-[.98] ${cat===id ? "bg-slate-900 text-white":"bg-white"}`}
                      onClick={()=>{ setCat(id); setOptionIdx(0); setPercent(""); }}
                    >{DRINKS[id].name}</button>
                  ))}
                </div>

                {cat==="cocktail" ? (
                  <>
                    <div>
                      <div className="text-xs text-slate-500">強さ</div>
                      <div className="flex flex-wrap gap-2 mt-2">
                        {DRINKS.cocktail.options.map((op, idx)=>(
                          <button key={op.label}
                            className={`h-11 px-3 rounded-xl text-sm font-semibold border active:scale-[.98] ${optionIdx===idx ? "bg-slate-900 text-white":"bg-white"}`}
                            onClick={()=>setOptionIdx(idx)}
                          >{op.label}</button>
                        ))}
                      </div>
                    </div>

                    <div className="bg-slate-50 border rounded-xl p-3 text-xs text-slate-600">
                      {optionIdx===0 && <p>弱め（10度前後）：カシスオレンジやファジーネーブルなど、ジュースベースの飲みやすいカクテル。</p>}
                      {optionIdx===1 && <p>レギュラー（20度前後）：ウォッカ、ジン、テキーラ、ラムなどのスピリッツをベースに他の材料を加えて作られます。</p>}
                      {optionIdx===2 && <p>強め（30度前後以上）：マティーニ、マンハッタン、モヒートなど、スピリッツ比率が高め。</p>}
                    </div>

                    <div className="grid grid-cols-3 gap-3 mt-2">
                      <div>
                        <div className="text-xs text-slate-500">純アル推定</div>
                        <div className="text-xl font-semibold">{displayG.toFixed(1)} g</div>
                      </div>
                      <div>
                        <div className="text-xs text-slate-500">次OKまで</div>
                        {nextOkMin===0 ? <div className="text-xl font-semibold">今すぐOK</div> : <div className="text-xl font-semibold">{nextOkMin} 分</div>}
                      </div>
                      <div className="flex items-end justify-end">
                        <button className="h-11 px-4 rounded-xl bg-slate-900 text-white font-semibold active:scale-[.98]" onClick={addDrink}>この内容で追加</button>
                      </div>
                    </div>
                  </>
                ) : (
                  <>
                    {!DRINKS[cat].simpleAdd && (
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <div className="text-xs text-slate-500">量</div>
                          <div className="flex flex-wrap gap-2 mt-2">
                            {DRINKS[cat].options.map((op, idx)=>(
                              <button key={op.label}
                                className={`h-11 px-3 rounded-xl text-sm font-semibold border active:scale-[.98] ${optionIdx===idx ? "bg-slate-900 text-white":"bg-white"}`}
                                onClick={()=>setOptionIdx(idx)}
                              >{op.label || "既定量"}</button>
                            ))}
                          </div>
                        </div>
                        {DRINKS[cat].allowPercent && (
                          <div>
                            <div className="text-xs text-slate-500">度数（%）</div>
                            <input className="w-full mt-1 border rounded-xl px-3 h-11" type="number"
                              min={DRINKS[cat].percentRange.min} max={DRINKS[cat].percentRange.max} step={DRINKS[cat].percentRange.step}
                              value={percent===""? DRINKS[cat].avgAbv : percent}
                              onChange={e=>setPercent(e.target.value===""? "" : Number(e.target.value))}
                            />
                            <div className="text-[11px] text-slate-500 mt-1">未入力時は平均{DRINKS[cat].avgAbv}%で推定</div>
                          </div>
                        )}
                      </div>
                    )}

                    <div className="grid grid-cols-3 gap-3">
                      <div>
                        <div className="text-xs text-slate-500">純アル推定</div>
                        <div className="text-xl font-semibold">{displayG.toFixed(1)} g</div>
                      </div>
                      <div>
                        <div className="text-xs text-slate-500">次OKまで</div>
                        {nextOkMin===0 ? <div className="text-xl font-semibold">今すぐOK</div> : <div className="text-xl font-semibold">{nextOkMin} 分</div>}
                      </div>
                      <div className="flex items-end justify-end">
                        <button className="h-11 px-4 rounded-xl bg-slate-900 text-white font-semibold active:scale-[.98]" onClick={addDrink}>この内容で追加</button>
                      </div>
                    </div>
                  </>
                )}
              </section>

              {/* History */}
              <section className="bg-white rounded-2xl p-4 shadow-sm" style={{display: (tab==="history"?"block":"none")}}>
                {history.length===0 ? (
                  <div className="text-slate-500">まだ履歴はありません。</div>
                ):(
                  <div className="grid gap-3">
                    {history.map(h => (
                      <div key={h.id} className="border rounded-xl p-3">
                        <div className="text-[11px] text-slate-500">{fmtTime(h.ts)}</div>
                        <div className="font-medium text-sm">{h.label}</div>
                        {h.type==="alcohol" && <div className="text-[11px] text-slate-500">純アル {h.g?.toFixed(1)} g</div>}
                      </div>
                    ))}
                  </div>
                )}
              </section>

              {/* Settings */}
              <section className="bg-white rounded-2xl p-4 shadow-sm grid gap-4" style={{display: (tab==="settings"?"grid":"none")}}>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <div className="text-xs text-slate-500">体重 (kg)</div>
                    <input className="w-full mt-1 border rounded-xl px-3 h-11" type="number" min="30" max="200"
                      value={weightKg} onChange={e=>setWeightKg(Number(e.target.value))} />
                  </div>
                  <div>
                    <div className="text-xs text-slate-500">年齢</div>
                    <input className="w-full mt-1 border rounded-xl px-3 h-11" type="number" min="16" max="99"
                      value={age} onChange={e=>setAge(Number(e.target.value))} />
                  </div>
                  <div className="col-span-2">
                    <div className="text-xs text-slate-500 mb-1">性別</div>
                    <div className="flex gap-2">
                      {[
                        {id:"male",label:"男性"},
                        {id:"female",label:"女性"},
                        {id:"other",label:"その他"},
                      ].map(opt=>(
                        <button key={opt.id} onClick={()=>setSex(opt.id)}
                          className={`h-11 px-3 rounded-xl text-sm font-semibold border active:scale-[.98] ${sex===opt.id ? "bg-slate-900 text-white":"bg-white"}`}>
                          {opt.label}
                        </button>
                      ))}
                    </div>
                    <div className="text-[11px] text-slate-500 mt-2">※ r={r.toFixed(2)} / 代謝 {burnRate.toFixed(1)} g/h（自動推定・目安）</div>
                  </div>
                </div>

                <button onClick={endSession} className="h-11 px-4 rounded-xl border font-semibold active:scale-[.98]">セッションを終了</button>
                <div className="text-[10px] text-slate-500">v0.4.0 PWA demo · データはこの端末のブラウザに保存されます（localStorage）</div>
              </section>
            </main>

            {/* FAB */}
            <button aria-label="飲む"
              className="fixed z-30 right-5 bottom-24 h-14 w-14 rounded-full shadow-lg bg-slate-900 text-white flex items-center justify-center active:scale-95"
              style="right:max(1.25rem, env(safe-area-inset-right)); bottom:calc(5.5rem + env(safe-area-inset-bottom));"
              onClick={()=>setTab("drink")}
            >＋</button>

            {/* Tabs */}
            <nav className="fixed inset-x-0 bottom-0 z-20 border-t border-slate-200 bg-white/95 backdrop-blur" style={{paddingBottom:"env(safe-area-inset-bottom)"}}>
              <div className="max-w-md mx-auto grid grid-cols-4">
                {["home","drink","history","settings"].map(t=>(
                  <button key={t} onClick={()=>setTab(t)}
                    className={`flex flex-col items-center justify-center h-14 gap-0.5 ${tab===t ? "text-slate-900":"text-slate-400"}`}
                    style={{minHeight:56}}
                  >
                    <span className="text-[11px] font-medium">
                      {t==="home"?"ホーム":t==="drink"?"飲む":t==="history"?"履歴":"設定"}
                    </span>
                  </button>
                ))}
              </div>
            </nav>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

  <script>
    // Service Worker registration (only works over HTTPS or on localhost)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .catch(err => console.log('SW registration failed:', err));
      });
    }
  </script>
</body>
</html>
